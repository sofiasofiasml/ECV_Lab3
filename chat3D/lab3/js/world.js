
var WORLD = {
    rooms: {},
    users:  {},
	friends: [],
    local_user: "",
	chats: [],
	actual_chat: "",
	walk_area:[],

	init: function(){
		this.loadWorld();
	},
	loadWorld: function(){
		this.walk_area = new WalkArea();
		this.walk_area.fromJSON({"areas":[[[-138.40635681152344,0,143.9536895751953],[-145.98104858398438,0,136.97711181640625],[-145.2307586669922,0,121.17062377929688],[-135.45428466796875,0,110.80111694335938],[-140.58596801757812,0,98.78411865234375],[-157.77761840820312,0,71.77935791015625],[-180.48858642578125,0,60.30901336669922],[-193.51016235351562,0,58.177032470703125],[-209.97711181640625,0,58.01230239868164],[-228.39584350585938,0,62.43254852294922],[-243.58258056640625,0,70.58946228027344],[-254.76034545898438,0,80.20855712890625],[-260.3860168457031,0,88.560302734375],[-255.48550415039062,0,89.96037292480469],[-249.85198974609375,0,92.05384826660156],[-249.0650634765625,0,104.27604675292969],[-251.27435302734375,0,130.14231872558594],[-254.4954833984375,0,145.88340759277344],[-254.61151123046875,0,152.8804473876953],[-244.1751708984375,0,155.81968688964844],[-229.3519287109375,0,149.5094757080078],[-222.5101318359375,0,145.89649963378906],[-216.87103271484375,0,133.4989776611328],[-211.19186401367188,0,122.90043640136719],[-203.69332885742188,0,112.54740905761719],[-190.08856201171875,0,114.02110290527344],[-184.47097778320312,0,124.38713073730469],[-186.1875,0,133.54188537597656],[-187.45529174804688,0,144.3522186279297],[-188.94309997558594,0,153.3551483154297],[-181.71206665039062,0,155.9369659423828],[-139.03298950195312,0,145.6238250732422]],[[-135.948486328125,0,146.28529357910156],[-134.5504913330078,0,153.68936157226562],[-136.2526397705078,0,159.2961883544922],[-141.2645721435547,0,171.05593872070312],[-147.14645385742188,0,180.7188720703125],[-159.28005981445312,0,190.6143341064453],[-171.46473693847656,0,196.52651977539062],[-184.19264221191406,0,202.86337280273438],[-197.67230224609375,0,205.32579040527344],[-210.63116455078125,0,202.16049194335938],[-229.38467407226562,0,196.4720001220703],[-243.54635620117188,0,189.8831787109375],[-260.7453308105469,0,174.98341369628906],[-269.51422119140625,0,161.44052124023438],[-275.0980224609375,0,145.951416015625],[-274.0279846191406,0,141.45469665527344],[-257.14007568359375,0,142.08013916015625],[-254.2812042236328,0,124.5426025390625],[-253.26693725585938,0,118.1817626953125],[-253.56155395507812,0,107.34080505371094],[-232.73912048339844,0,110.57254028320312],[-224.17062377929688,0,117.52777099609375],[-217.7334747314453,0,130.98170471191406],[-212.30569458007812,0,140.82228088378906],[-204.5783233642578,0,146.18313598632812],[-197.34793090820312,0,146.68649291992188],[-189.268798828125,0,142.60858154296875],[-185.3580322265625,0,134.06124877929688],[-137.75469970703125,0,142.0763397216797],[-135.2400665283203,0,139.9351043701172]],[[-0.9962158203125,0,147.83245849609375],[-0.4546356201171875,0,129.28665161132812],[-144.89456176757812,0,128.47589111328125],[-144.6507568359375,0,141.82308959960938],[-136.9736328125,0,147.22459411621094]],[[9.593514442443848,0,276.1041564941406],[7.332314491271973,0,250.39306640625],[-6.082281112670898,0,248.71139526367188],[-8.09023666381836,0,247.30555725097656],[-8.07818603515625,0,230.14183044433594],[11.131179809570312,0,230.57565307617188],[15.35113525390625,0,230.57223510742188],[14.014877319335938,0,203.91168212890625],[6.27667236328125,0,193.3488006591797],[-4.757698059082031,0,195.93287658691406],[-7.089302062988281,0,203.9761505126953],[-13.461984634399414,0,206.1615753173828],[-27.83103370666504,0,215.4453887939453],[-26.396106719970703,0,224.385498046875],[-27.071453094482422,0,234.67495727539062],[-28.90755271911621,0,243.43841552734375],[-37.057334899902344,0,243.26039123535156],[-34.649654388427734,0,254.24478149414062],[-28.60091781616211,0,263.01611328125],[-17.601791381835938,0,274.451904296875],[-7.775566101074219,0,275.71484375],[3.0608673095703125,0,275.74029541015625],[8.35788345336914,0,277.02508544921875]],[[-12.733306884765625,0,75.98255920410156],[-18.024871826171875,0,18.184246063232422],[-22.066482543945312,0,12.793913841247559],[-20.809295654296875,0,3.5441665649414062],[-20.372085571289062,0,-7.829275131225586],[-19.0731201171875,0,-17.472291946411133],[-18.350173950195312,0,-27.528440475463867],[-19.348052978515625,0,-34.04181671142578],[-21.291244506835938,0,-46.72576141357422],[-21.605499267578125,0,-60.02449035644531],[-22.678253173828125,0,-63.261436462402344],[-29.546539306640625,0,-60.570770263671875],[-36.38999938964844,0,-56.854736328125],[-45.039031982421875,0,-51.838340759277344],[-49.90184020996094,0,-47.07221984863281],[-53.76490783691406,0,-43.11309051513672],[-57.70680236816406,0,-37.9825439453125],[-62.16032409667969,0,-29.52419090270996],[-65.46134948730469,0,-20.286752700805664],[-68.0089111328125,0,-9.84330940246582],[-69.13111877441406,0,-2.8212413787841797],[-70.85440063476562,0,6.910228729248047],[-68.75680541992188,0,25.239120483398438],[-64.04322814941406,0,37.59144592285156],[-59.12310791015625,0,48.37420654296875],[-53.13526916503906,0,55.42488098144531],[-47.353424072265625,0,59.62751770019531],[-37.06779479980469,0,66.30196380615234],[-27.114212036132812,0,71.5274429321289],[-11.638595581054688,0,75.42440795898438]],[[-12.444072723388672,0,75.21636962890625],[-11.709171295166016,0,76.2613296508789],[-17.266765594482422,0,19.199800491333008],[14.643318176269531,0,19.03775978088379],[23.550857543945312,0,8.128372192382812],[25.064285278320312,0,-8.629165649414062],[20.39935302734375,0,-17.19500732421875],[15.5123291015625,0,-25.35150718688965],[18.583648681640625,0,-30.533510208129883],[25.436065673828125,0,-33.9512939453125],[38.99615478515625,0,-34.408897399902344],[55.44157409667969,0,-35.37291717529297],[63.42340087890625,0,-21.3527889251709],[65.44268798828125,0,-8.691884994506836],[68.13192749023438,0,6.541389465332031],[67.43307495117188,0,17.789764404296875],[63.9014892578125,0,30.922290802001953],[55.45643615722656,0,44.88475799560547],[46.587249755859375,0,57.157569885253906],[36.1527099609375,0,66.9788818359375],[23.751251220703125,0,75.00408935546875],[-5.3455810546875,0,75.0659408569336]],[[14.37738037109375,0,185.21368408203125],[14.147688865661621,0,202.60316467285156],[16.444381713867188,0,208.48825073242188],[27.19098472595215,0,218.7067108154297],[32.87220001220703,0,226.97512817382812],[36.34788131713867,0,237.9964599609375],[36.808570861816406,0,246.43020629882812],[32.9708251953125,0,258.2674865722656],[23.410293579101562,0,268.01806640625],[16.0301513671875,0,272.4063720703125],[7.9572343826293945,0,275.8615417480469],[3.143383264541626,0,278.47900390625],[2.7281994819641113,0,252.2721710205078],[9.50352668762207,0,249.85324096679688],[9.740012168884277,0,238.20362854003906],[8.510566711425781,0,230.71502685546875],[9.068078994750977,0,199.88204956054688],[9.218061447143555,0,185.9960174560547]],[[18.5478515625,0,74.77117919921875],[17.447189331054688,0,190.64564514160156],[17.05633544921875,0,195.4185333251953],[-7.2385711669921875,0,194.47023010253906],[-7.941375732421875,0,76.11029052734375]]]});
		names = ["Italia","Egipto","Pasillo1","Pasillo2","Francia"];
		for (var i=0;i<5;i++){
			var room = this.createRoom(i,names[i]);
		}
	},
	fromJSON: function(){
		return 1
	},
	toJSON: function(){
		var o = {
			rooms: []
		};
		for (var i=0;i<this.rooms.length;i++){
			var room = this.rooms[i];
			o.rooms.push(room.toJSON());
		}
		return o
	},
	createUser: function(id,username="undefined",room=0){
		this.users[id]=  new User(username,id);
		this.users[id].character=new RD.SceneNode({
			position: [-40,0,0]
		});
		return this.users[id]
	},
	newMessage: function(cont,user,type){
		var usrname=user.name;
		var cont =cont;
		var msg = {
			type: type,
			content: cont,
			username:usrname
		};
		var areaMessg = document.querySelector("#MessageArea"); 
		if(type=="text" ||type=="private"){
			//create element for the DOM
			var elem = document.createElement("p");
			var name = document.createElement("div");
			var content = document.createElement("div");
			content.className="cont";
			name.className="username";		
			if (user.id==WORLD.local_user.id)elem.className = "from-me";
			else elem.className = "from-them";
			content.innerHTML = cont;
			name.innerHTML = usrname;
			elem.appendChild(name);
			elem.appendChild(content);
			areaMessg.appendChild(elem);
			if(scene)
				areaMessg.style.display = 'block'; 
			setTimeout(delatemessage,8000);
		}
		

		return msg;
	},
	createRoom: function(id,name,areaBool){
		if(areaBool==true){
			var area = this.walk_area.areas[id];
			var room = new Room(id,name,area);
		}
		else var room = new Room(id,name);
		
		this.rooms[id]=room;
		return room
	},
	updateUser: function(){
		var user = this.local_user;
		if(this.local_user){
			var message = {type:"user_update",user:user.toJSON()};
			server.sendMessage(message);
		}
	},
	updatePos: function(){
		var user = this.local_user;
		if(this.local_user){
			var message = {type:"pos_update",user:user.toJSON()};
			server.sendMessage(message);
		}
	},

	changeRoom: function(room_index,user){
		var room = this.rooms[room_index];
		if(!user) var user = this.local_user;
		if(this.local_user){
			var message = {type:"change_room",user:user.toJSON(),room:room_index};
			server.sendMessage(message);
		}
	},
}
function User(username="anynymous",id){
	this.name =username;
	this.character = "";
	this.id=id;
	this.room_index=-1;
	this._connection ="";
	this.goPos = "";
	this.node=0;
}
User.prototype.fromJSON = function(json) {
	this.id = json.id;
	this.name=json.name;
	this.character.position = json.position;
	this.room_index =json.room_index;
};
User.prototype.toJSON = function() {
	return {
		id: this.id,
		name: this.name,
		position: this.character.position,
		room_index: this.room_index
	} 
};

function Room(id,name="unknown",area=""){
	this.users=[];
	this.name=name;
	this.index= id;
	this.area=area;
}
Room.prototype.enterUser=function(user){
	this.users.push(user.id);
	user.room_index = this.index;
	console.log("User "+user.id+" has entered Room "+this.index);
}
Room.prototype.leaveUser=function(user){
	var index = this.users.indexOf(user.id);
	this.users.splice(index,1);
}
Room.prototype.newMessage=function(cont,user,type){
	var usrname=user.name;
	var cont =cont;
	var msg = {
		type: type,
		content: cont,
		username:usrname
	};
	return msg
}
Room.prototype.fromJSON=function(json){
	this.index=json.id;
	this.name = json.name;
	if (json.users){
		this.users =json.users.concat();
	}
}
Room.prototype.toJSON=function(){
	var json = {
		id: this.index,
		name: this.name,
		users: this.users
	};
	return json
}


 function sendMessageUsersRoom(content)
{
	var room_index = WORLD.local_user.room_index;
	var room = WORLD.rooms[room_index];
	var listUsers=[];
	for (var i=0;i<room.users.length; i++){
		// giveavatarsprite(); 
		var avatar_id = room.users[i];
		listUsers.push(avatar_id);
	}
	var msg= WORLD.newMessage(content,WORLD.local_user,"private");
	var message= {type:msg.type,data:msg.content,users:listUsers,room:room.index,user:WORLD.local_user};
	sendMessage(message);
	
}
function delatemessage()
{
	var areaMessg = document.querySelector("#MessageArea"); 
	var first = areaMessg.firstElementChild;
	first.remove();
	var areaMessg = document.querySelector("#MessageArea"); 
	var first = areaMessg.firstElementChild;
	if(first == null)
	{
		areaMessg.style.display = 'none'; 
	}
}